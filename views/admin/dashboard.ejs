<%- include('../partials/header') %>
<section class="card reveal section-head">
  <h1>Admin Dashboard</h1>
  <p>현재 이 화면에서는 멤버 승인과 AI 연결 설정만 관리합니다.</p>
</section>

<section class="grid two-col">
  <article class="card reveal">
    <h2>Pending Membership Requests</h2>
    <% if (pendingRequests.length === 0) { %>
      <p class="muted">No pending requests.</p>
    <% } %>

    <% pendingRequests.forEach((req) => { %>
      <div class="item-row">
        <div>
          <strong><%= req.name %></strong><br />
          <small><%= req.email %></small>
        </div>
        <div class="row">
          <form method="post" action="/admin/member-requests/<%= req.id %>/approve">
            <button class="btn small" type="submit">Approve</button>
          </form>
          <form method="post" action="/admin/member-requests/<%= req.id %>/reject">
            <button class="btn ghost small" type="submit">Reject</button>
          </form>
        </div>
      </div>
    <% }) %>
  </article>

  <article class="card reveal">
    <h2>AI / API Settings</h2>
    <p class="muted">상태: <strong><%= apiConfigured ? 'Configured' : 'Not Configured' %></strong></p>
    <form method="post" action="/admin/api-settings" class="form">
      <label>Provider Name <input name="aiProvider" value="<%= apiSettings.ai_provider || '' %>" /></label>
      <label>API URL <input name="aiUrl" value="<%= apiSettings.ai_url || '' %>" placeholder="https://..." /></label>
      <label>API Key <input name="aiKey" value="<%= apiSettings.ai_key || '' %>" /></label>
      <label>Model <input name="aiModel" value="<%= apiSettings.ai_model || '' %>" /></label>
      <label>Blog System Prompt
        <textarea name="aiBlogSystemPrompt" rows="3"><%= apiSettings.ai_blog_system_prompt || '' %></textarea>
      </label>
      <label>Category System Prompt
        <textarea name="aiCategorySystemPrompt" rows="3"><%= apiSettings.ai_category_system_prompt || '' %></textarea>
      </label>
      <div class="api-action-row">
        <button class="btn api-action-btn" type="submit">Save API Settings</button>
        <button
          class="btn api-action-btn api-action-btn-secondary"
          type="submit"
          formaction="/admin/api-settings/test"
          formmethod="post"
        >
          Test AI Connection
        </button>
      </div>
    </form>
  </article>
</section>

<section class="card reveal">
  <h2>Family Profile Photos</h2>
  <p class="muted">랜딩 페이지의 원형 프로필에 표시할 이미지를 업로드하고 크롭할 수 있습니다.</p>
  <div class="family-profile-grid">
    <% familyProfiles.forEach((profile) => { %>
      <article class="family-profile-item" data-family-profile-id="<%= profile.id %>">
        <div class="family-profile-photo">
          <% if (profile.profile_image_url) { %>
            <img
              src="<%= profile.profile_image_url %>"
              alt="<%= profile.name %> profile"
              data-family-profile-image="<%= profile.id %>"
              loading="lazy"
            />
          <% } else { %>
            <span data-family-profile-initial="<%= profile.id %>"><%= profile.name.charAt(0) %></span>
          <% } %>
        </div>
        <strong><%= profile.name %></strong>
        <form method="post" action="/admin/family-profiles/<%= profile.id %>/bio" class="form family-profile-bio-form">
          <label>소개 문구
            <textarea name="profileBio" rows="4" maxlength="600"><%= profile.profile_bio || '' %></textarea>
          </label>
          <div class="row family-profile-action-row">
            <button class="btn family-action-btn profile-action-btn" type="submit">소개문구 저장</button>
            <button
              class="btn family-action-btn ghost profile-action-btn"
              type="button"
              data-open-profile-photo-dialog
              data-profile-id="<%= profile.id %>"
              data-profile-name="<%= profile.name %>"
            >
              개인사진 수정
            </button>
          </div>
        </form>
      </article>
    <% }) %>
  </div>
</section>

<section class="grid two-col admin-utility-grid">
  <article class="card reveal">
    <div class="landing-bg-admin-block">
      <div class="row between landing-bg-admin-title-row">
        <h2>Landing Background Photo</h2>
        <button class="btn family-action-btn landing-bg-action-btn" type="button" id="openLandingBgDialogBtn">배경사진 수정</button>
      </div>
      <p class="muted">랜딩 페이지 뒤에 아주 옅게 깔릴 배경 사진을 교체합니다.</p>
      <div class="landing-bg-admin-preview">
        <% if (landingBackgroundImage) { %>
          <img
            src="<%= landingBackgroundImage %>"
            alt="Landing background preview"
            id="landingBgPreviewImage"
            loading="lazy"
          />
        <% } else { %>
          <div class="landing-bg-admin-empty" id="landingBgPreviewEmpty">No background image yet</div>
          <img
            src=""
            alt="Landing background preview"
            id="landingBgPreviewImage"
            class="hidden-block"
          />
        <% } %>
      </div>
    </div>
  </article>

  <article class="card reveal admin-password-card">
    <h2>Change My Password</h2>
    <p class="muted">현재 비밀번호를 확인한 뒤 새 비밀번호로 변경합니다.</p>
    <form method="post" action="/admin/password/change" class="form password-form-split">
      <div class="password-fields">
        <label>Current Password
          <input type="password" name="currentPassword" required />
        </label>
        <label>New Password
          <input type="password" name="newPassword" minlength="4" required />
        </label>
        <label>Confirm New Password
          <input type="password" name="confirmPassword" minlength="4" required />
        </label>
      </div>
      <button class="btn family-action-btn password-update-btn" type="submit">Update Password</button>
    </form>
  </article>
</section>

<dialog id="landingBgDialog" class="modal modal-wide">
  <div class="modal-content">
    <div class="row between">
      <h2>랜딩 배경사진 수정</h2>
      <button class="btn ghost small" type="button" id="closeLandingBgDialogBtn">닫기</button>
    </div>
    <p class="muted">확대 후 마우스로 드래그해 위치를 맞추고 저장하세요. 적용 시 항상 옅은 투명도로 표시됩니다.</p>
    <div class="form profile-photo-form">
      <input type="file" id="landingBgFileInput" accept="image/*" />
      <canvas id="landingBgCropCanvas" class="landing-bg-crop-canvas" width="1600" height="900"></canvas>
      <label>확대
        <input type="range" id="landingBgZoomRange" min="1" max="3" step="0.01" value="1" />
      </label>
      <div class="row">
        <button class="btn ghost small" type="button" id="resetLandingBgCropBtn">초기화</button>
        <button class="btn small family-action-btn" type="button" id="saveLandingBgBtn">저장</button>
      </div>
    </div>
  </div>
</dialog>

<dialog id="profilePhotoDialog" class="modal">
  <div class="modal-content">
    <div class="row between">
      <h2 id="profilePhotoDialogTitle">개인사진 수정</h2>
      <button class="btn ghost small" type="button" id="closeProfilePhotoDialogBtn">닫기</button>
    </div>
    <p class="muted">원형 프레임에 맞춰 확대 후, 이미지를 마우스로 드래그해 위치를 맞추세요.</p>
    <div class="form profile-photo-form">
      <input type="file" id="profilePhotoFileInput" accept="image/*" />
      <canvas id="profilePhotoCropCanvas" class="profile-crop-canvas" width="600" height="600"></canvas>
      <label>확대
        <input type="range" id="profileZoomRange" min="1" max="3" step="0.01" value="1" />
      </label>
      <div class="row">
        <button class="btn ghost small" type="button" id="resetProfileCropBtn">초기화</button>
        <button class="btn small" type="button" id="saveProfilePhotoBtn">저장</button>
      </div>
    </div>
  </div>
</dialog>

<script>
  window.__familyProfiles = <%- JSON.stringify(familyProfiles || []) %>;
</script>
<script defer src="/js/admin-dashboard.js"></script>

<%- include('../partials/footer') %>
